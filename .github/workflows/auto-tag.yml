name: Auto Tag and Release

on:
    push:
        branches:
            - main

jobs:
    tag:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Get version from pyproject.toml
              id: get_version
              run: |
                  # Extract version from pyproject.toml
                  VERSION=$(grep "^version" pyproject.toml | head -1 | cut -d'"' -f2)
                  NEW_VERSION="v${VERSION}"
                  echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "Version from pyproject.toml: $NEW_VERSION"

            - name: Check if tag already exists
              id: check_tag
              run: |
                  NEW_VERSION=${{ steps.get_version.outputs.version }}
                  if git rev-parse "$NEW_VERSION" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "⚠️ Tag $NEW_VERSION already exists, skipping release"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "✅ Tag $NEW_VERSION does not exist, will create"
                  fi

            - name: Create and push tag
              if: steps.check_tag.outputs.exists == 'false'
              run: |
                  NEW_VERSION=${{ steps.get_version.outputs.version }}
                  COMMIT_MSG=$(git log -1 --pretty=%B)

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION" -m "$COMMIT_MSG"
                  git push origin "$NEW_VERSION"

                  echo "✅ Created and pushed tag: $NEW_VERSION"

            - name: Create GitHub Release
              if: steps.check_tag.outputs.exists == 'false'
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  gh release create "${{ steps.get_version.outputs.version }}" \
                    --title "Release ${{ steps.get_version.outputs.version }}" \
                    --generate-notes
